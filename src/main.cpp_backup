#include <WiFi.h>
#include <ArduinoJson.h>
#include <HTTPClient.h>

// WiFi –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏
const char *ssid = "MikroTik-9DA0AC";
const char *password = "MYZLMGFPT3";

// Home Assistant REST API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const char *ha_server = "192.168.88.13";
const int ha_port = 30123;                                                                                                                                                                                        // –ü–æ—Ä—Ç Home Assistant (–æ–±—ã—á–Ω–æ 8123)
const char *ha_token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJkZWU1MDMxNTUwOGM0OGVkOGYzOTVjNTJkOTM1YzllMCIsImlhdCI6MTc2NzI3MjUxMywiZXhwIjoyMDgyNjMyNTEzfQ.hSO2cB2AGafJQgpSCoRIS9B2tlsBHoO-Iv83sjfplDs"; // Long-Lived Access Token –∏–∑ HA
// Entity ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ Home Assistant (–Ω–∞–π–¥–∏ –≤ HA: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -> –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–ª—É–∂–±—ã -> Zigbee2MQTT)
// –û–±—ã—á–Ω–æ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ: "sensor.conditioner_socket_power" –∏–ª–∏ "sensor.pc_socket_power"
const char *ha_entity_id = "sensor.conditioner_socket_power";

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ—â–Ω–æ—Å—Ç–∏ (–≤ –≤–∞—Ç—Ç–∞—Ö)
float powerWatts = 0.0;
bool powerReceived = false; // –§–ª–∞–≥, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã —Ö–æ—Ç—è –±—ã —Ä–∞–∑

// ========== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï 7-–°–ï–ì–ú–ï–ù–¢–ù–´–• –î–ò–°–ü–õ–ï–ï–í ==========
//
// –£ —Ç–µ–±—è 2 –¥–∏—Å–ø–ª–µ—è (–ª–µ–≤—ã–π –∏ –ø—Ä–∞–≤—ã–π), –∫–∞–∂–¥—ã–π –Ω–∞ 3 —Ü–∏—Ñ—Ä—ã
// –õ–µ–≤—ã–π –¥–∏—Å–ø–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–µ 3 —Ü–∏—Ñ—Ä—ã —á–∏—Å–ª–∞
// –ü—Ä–∞–≤—ã–π –¥–∏—Å–ø–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Ü–∏—Ñ—Ä—ã —á–∏—Å–ª–∞
//
// –ö–ê–ñ–î–´–ô –¥–∏—Å–ø–ª–µ–π –∏–º–µ–µ—Ç —Å–≤–æ–∏ –ø–∏–Ω—ã: DIO, SCK, RCK, GND, +5V
//
// –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –õ–ï–í–û–ì–û –î–ò–°–ü–õ–ï–Ø:
//   DIO  ‚Üí GPIO 23 (ESP32)  ‚Üí Data In (DS/SER –Ω–∞ —Å–¥–≤–∏–≥–æ–≤–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
//   SCK  ‚Üí GPIO 18 (ESP32)  ‚Üí Serial Clock (SH_CP/CLK –Ω–∞ —Å–¥–≤–∏–≥–æ–≤–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
//   RCK  ‚Üí GPIO 19 (ESP32)  ‚Üí Register Clock/Latch (ST_CP/LATCH –Ω–∞ —Å–¥–≤–∏–≥–æ–≤–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
//   GND  ‚Üí GND (ESP32)      ‚Üí –û–±—â–∏–π –ø—Ä–æ–≤–æ–¥ (–∑–µ–º–ª—è) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±—â–∏–π —Å ESP32!
//   +5V  ‚Üí –í–ê–†–ò–ê–ù–¢ 1: –í–ù–ï–®–ù–ò–ô –ò–°–¢–û–ß–ù–ò–ö 5V (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
//          –í–ê–†–ò–ê–ù–¢ 2: 3.3V (ESP32) - –ø–æ–ø—Ä–æ–±—É–π, –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (—Å–º. –Ω–∏–∂–µ)
//
// –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ü–†–ê–í–û–ì–û –î–ò–°–ü–õ–ï–Ø:
//   DIO  ‚Üí GPIO 25 (ESP32)  ‚Üí Data In (DS/SER –Ω–∞ —Å–¥–≤–∏–≥–æ–≤–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
//   SCK  ‚Üí GPIO 26 (ESP32)  ‚Üí Serial Clock (SH_CP/CLK –Ω–∞ —Å–¥–≤–∏–≥–æ–≤–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
//   RCK  ‚Üí GPIO 27 (ESP32)  ‚Üí Register Clock/Latch (ST_CP/LATCH –Ω–∞ —Å–¥–≤–∏–≥–æ–≤–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
//   GND  ‚Üí GND (ESP32)      ‚Üí –û–±—â–∏–π –ø—Ä–æ–≤–æ–¥ (–∑–µ–º–ª—è) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±—â–∏–π —Å ESP32!
//   +5V  ‚Üí –í–ê–†–ò–ê–ù–¢ 1: –í–ù–ï–®–ù–ò–ô –ò–°–¢–û–ß–ù–ò–ö 5V (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
//          –í–ê–†–ò–ê–ù–¢ 2: 3.3V (ESP32) - –ø–æ–ø—Ä–æ–±—É–π, –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (—Å–º. –Ω–∏–∂–µ)
//
// –í–ê–†–ò–ê–ù–¢ 1: –ü–ò–¢–ê–ù–ò–ï –û–¢ 5V (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø):
//   - ESP32 —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 3.3V –∏ –ù–ï –∏–º–µ–µ—Ç –≤—ã—Ö–æ–¥–∞ 5V
//   - –î–ª—è –ø–∏—Ç–∞–Ω–∏—è –¥–∏—Å–ø–ª–µ–µ–≤ –Ω—É–∂–µ–Ω –í–ù–ï–®–ù–ò–ô –∏—Å—Ç–æ—á–Ω–∏–∫ 5V:
//     * USB –±–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è 5V (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç –∑–∞—Ä—è–¥–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
//     * –ë–ª–æ–∫ –ø–∏—Ç–∞–Ω–∏—è 5V —Å —Ä–∞–∑—ä–µ–º–æ–º DC
//     * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å 3.3V ‚Üí 5V (–µ—Å–ª–∏ –ø–∏—Ç–∞–µ—à—å ESP32 –æ—Ç –±–∞—Ç–∞—Ä–µ–∏)
//   - GND –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—â–∏–π –º–µ–∂–¥—É ESP32 –∏ –¥–∏—Å–ø–ª–µ—è–º–∏!
//   - +5V –º–æ–∂–Ω–æ –æ–±—â–∏–π –¥–ª—è –æ–±–æ–∏—Ö –¥–∏—Å–ø–ª–µ–µ–≤, –µ—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤—ã–¥–µ—Ä–∂–∏—Ç —Ç–æ–∫
//
// –í–ê–†–ò–ê–ù–¢ 2: –ü–ò–¢–ê–ù–ò–ï –û–¢ 3.3V (–≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–ê–õ–¨–ù–û):
//   - –ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å +5V –¥–∏—Å–ø–ª–µ—è –∫ 3.3V ESP32
//   - –ú–ù–û–ì–ò–ï —Å–¥–≤–∏–≥–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã (74HC595, 74HC164 –∏ —Ç.–¥.) –†–ê–ë–û–¢–ê–Æ–¢ –æ—Ç 3.3V!
//   - –ü—Ä–æ–≤–µ—Ä—å –¥–∞—Ç–∞—à–∏—Ç —Å–≤–æ–µ–π –º–∏–∫—Ä–æ—Å—Ö–µ–º—ã - —Ç–∞–º —É–∫–∞–∑–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω –ø–∏—Ç–∞–Ω–∏—è (–æ–±—ã—á–Ω–æ 2V-6V)
//   - –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê: –Ω–µ –Ω—É–∂–µ–Ω –≤–Ω–µ—à–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫, –ø—Ä–æ—â–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
//   - –ù–ï–î–û–°–¢–ê–¢–ö–ò:
//     * –Ø—Ä–∫–æ—Å—Ç—å –¥–∏—Å–ø–ª–µ—è –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ (LED —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Ç –º–µ–Ω—å—à–µ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è)
//     * –ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–æ–±—â–µ, –µ—Å–ª–∏ –º–∏–∫—Ä–æ—Å—Ö–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç —Å—Ç—Ä–æ–≥–æ 5V
//     * –†–∏—Å–∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ ESP32 –ø–æ —Ç–æ–∫—É (–µ—Å–ª–∏ –¥–∏—Å–ø–ª–µ–∏ –∂—Ä—É—Ç –º–Ω–æ–≥–æ)
//   - –í–ê–ñ–ù–û: GND –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—â–∏–π —Å ESP32!
//   - –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –¥–∏—Å–ø–ª–µ–π —Ç—É—Å–∫–ª—ã–π - –≤–µ—Ä–Ω–∏—Å—å –∫ –≤–∞—Ä–∏–∞–Ω—Ç—É 1 (5V)
//
// –í–ê–ñ–ù–û –ü–†–û –õ–û–ì–ò–ß–ï–°–ö–ò–ï –£–†–û–í–ù–ò:
//   - ESP32 –≤—ã–¥–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã 3.3V –Ω–∞ GPIO –ø–∏–Ω–∞—Ö
//   - –ï—Å–ª–∏ –ø–∏—Ç–∞–µ—à—å —Å–¥–≤–∏–≥–æ–≤—ã–π —Ä–µ–≥–∏—Å—Ç—Ä –æ—Ç 3.3V - –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –≤—Å–µ –û–ö
//   - –ï—Å–ª–∏ –ø–∏—Ç–∞–µ—à—å –æ—Ç 5V, –Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 3.3V –ª–æ–≥–∏–∫—É - —Ç–æ–∂–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
//   - –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å —É—Ä–æ–≤–Ω—è 3.3V ‚Üí 5V –¥–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤
//     (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–¥—É–ª—å —Å –ª–æ–≥–∏–∫–æ–π TXB0104 –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ä–µ–∑–∏—Å—Ç–æ—Ä—ã-–ø–æ–¥—Ç—è–∂–∫–∏)
//
// –î–†–£–ì–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò:
//   - –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥—Ä—É–≥–∏–µ GPIO –ø–∏–Ω—ã - –∏–∑–º–µ–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∏–∂–µ

// –õ–µ–≤—ã–π –¥–∏—Å–ø–ª–µ–π - GPIO –ø–∏–Ω—ã
#define DISPLAY_LEFT_DIO 23 // Data In (DS/SER)
#define DISPLAY_LEFT_SCK 18 // Serial Clock (SH_CP/CLK)
#define DISPLAY_LEFT_RCK 19 // Register Clock/Latch (ST_CP/LATCH)

// –ü—Ä–∞–≤—ã–π –¥–∏—Å–ø–ª–µ–π - GPIO –ø–∏–Ω—ã
#define DISPLAY_RIGHT_DIO 25 // Data In (DS/SER)
#define DISPLAY_RIGHT_SCK 26 // Serial Clock (SH_CP/CLK)
#define DISPLAY_RIGHT_RCK 27 // Register Clock/Latch (ST_CP/LATCH)

// –ö–æ–¥–∏—Ä–æ–≤–∫–∞ —Ü–∏—Ñ—Ä –¥–ª—è 7-—Å–µ–≥–º–µ–Ω—Ç–Ω–æ–≥–æ –¥–∏—Å–ø–ª–µ—è (–æ–±—â–∏–π –∫–∞—Ç–æ–¥)
// –°–µ–≥–º–µ–Ω—Ç—ã: A B C D E F G DP (DP - —Ç–æ—á–∫–∞)
// –ë–∏—Ç:      0 1 2 3 4 5 6 7
// –í–ê–ñ–ù–û: –ï—Å–ª–∏ –¥–∏—Å–ø–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ö–µ—Ä–Ω—é - –≤–æ–∑–º–æ–∂–Ω–æ —É —Ç–µ–±—è –æ–±—â–∏–π –∞–Ω–æ–¥!
// –¢–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –±–∏—Ç—ã: ~digitPatterns[i]
// –ò–ª–∏ –ø–æ–º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –ø–æ-–¥—Ä—É–≥–æ–º—É
const uint8_t digitPatterns[10] = {
    0b11111100, // 0: A B C D E F
    0b01100000, // 1: B C
    0b11011010, // 2: A B D E G
    0b11110010, // 3: A B C D G
    0b01100110, // 4: B C F G
    0b10110110, // 5: A C D F G
    0b10111110, // 6: A C D E F G
    0b11100000, // 7: A B C
    0b11111110, // 8: A B C D E F G
    0b11110110  // 9: A B C D F G
};

// Forward declaration
bool fetchPowerFromHomeAssistant();
void initDisplay();
void displayNumber(float number);
void shiftOutByte(uint8_t data, uint8_t dioPin, uint8_t sckPin);
void updateDisplay(uint8_t digits[6]);
void clearDisplay(); // –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–ø–ª–µ—è
void testSegments(); // –¢–µ—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞

void setup_wifi()
{
  delay(10);
  Serial.println();
  Serial.print("–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ WiFi: ");
  Serial.println(ssid);

  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED)
  {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.println("WiFi –ø–æ–¥–∫–ª—é—á–µ–Ω!");
  Serial.print("IP –∞–¥—Ä–µ—Å: ");
  Serial.println(WiFi.localIP());
}

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø 7-–°–ï–ì–ú–ï–ù–¢–ù–û–ì–û –î–ò–°–ü–õ–ï–Ø ==========

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏–Ω–æ–≤ –æ–±–æ–∏—Ö –¥–∏—Å–ø–ª–µ–µ–≤
void initDisplay()
{
  // –õ–µ–≤—ã–π –¥–∏—Å–ø–ª–µ–π
  pinMode(DISPLAY_LEFT_DIO, OUTPUT);
  pinMode(DISPLAY_LEFT_SCK, OUTPUT);
  pinMode(DISPLAY_LEFT_RCK, OUTPUT);

  digitalWrite(DISPLAY_LEFT_DIO, LOW);
  digitalWrite(DISPLAY_LEFT_SCK, LOW);
  digitalWrite(DISPLAY_LEFT_RCK, LOW);

  // –ü—Ä–∞–≤—ã–π –¥–∏—Å–ø–ª–µ–π
  pinMode(DISPLAY_RIGHT_DIO, OUTPUT);
  pinMode(DISPLAY_RIGHT_SCK, OUTPUT);
  pinMode(DISPLAY_RIGHT_RCK, OUTPUT);

  digitalWrite(DISPLAY_RIGHT_DIO, LOW);
  digitalWrite(DISPLAY_RIGHT_SCK, LOW);
  digitalWrite(DISPLAY_RIGHT_RCK, LOW);

  Serial.println("‚úÖ –û–±–∞ –¥–∏—Å–ø–ª–µ—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã");
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ –±–∞–π—Ç–∞ –≤ —Å–¥–≤–∏–≥–æ–≤—ã–π —Ä–µ–≥–∏—Å—Ç—Ä (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
void shiftOutByte(uint8_t data, uint8_t dioPin, uint8_t sckPin)
{
  // –ü—Ä–æ–±—É–µ–º LSB first (–º–ª–∞–¥—à–∏–π –±–∏—Ç –ø–µ—Ä–≤—ã–º) - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–∞–∫
  for (int i = 0; i < 8; i++)
  {
    digitalWrite(dioPin, (data >> i) & 0x01);

    // –¢–∞–∫—Ç–æ–≤—ã–π –∏–º–ø—É–ª—å—Å
    digitalWrite(sckPin, HIGH);
    delayMicroseconds(5);
    digitalWrite(sckPin, LOW);
    delayMicroseconds(5);
  }
}

// –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–ø–ª–µ—è (–≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã –≤—ã–∫–ª—é—á–µ–Ω—ã)
void clearDisplay()
{
  uint8_t emptyDigits[6] = {0, 0, 0, 0, 0, 0};
  updateDisplay(emptyDigits);
  delay(10);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –¥–∏—Å–ø–ª–µ—è (3 —Ü–∏—Ñ—Ä—ã)
void updateSingleDisplay(uint8_t digits[3], uint8_t dioPin, uint8_t sckPin, uint8_t rckPin)
{
  // –í–ê–ñ–ù–û: –ó–∞—â–µ–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å LOW –≤–æ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  digitalWrite(rckPin, LOW);
  delayMicroseconds(10); // –£–≤–µ–ª–∏—á–∏–ª –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

  // –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ü–∏—Ñ—Ä—ã —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ (–ø–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ –∏–¥–µ—Ç –ø–µ—Ä–≤–æ–π)
  for (int i = 0; i < 3; i++)
  {
    shiftOutByte(digits[i], dioPin, sckPin);
  }

  // –í–ê–ñ–ù–û: –í–∫–ª—é—á–∞–µ–º –∑–∞—â–µ–ª–∫—É –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
  // –≠—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–¥–≤–∏–≥–æ–≤–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –≤ –≤—ã—Ö–æ–¥–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä
  digitalWrite(rckPin, HIGH);
  delayMicroseconds(50); // –£–≤–µ–ª–∏—á–∏–ª –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
  digitalWrite(rckPin, LOW);
  delayMicroseconds(10);
}

// –¢–µ—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
void testSegments()
{
  Serial.println("=== –¢–ï–°–¢ –°–ï–ì–ú–ï–ù–¢–û–í ===");

  // –¢–µ—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ (A, B, C, D, E, F, G, DP)
  uint8_t segments[8] = {
      0b00000001, // A (—Å–µ–≥–º–µ–Ω—Ç 0)
      0b00000010, // B (—Å–µ–≥–º–µ–Ω—Ç 1)
      0b00000100, // C (—Å–µ–≥–º–µ–Ω—Ç 2)
      0b00001000, // D (—Å–µ–≥–º–µ–Ω—Ç 3)
      0b00010000, // E (—Å–µ–≥–º–µ–Ω—Ç 4)
      0b00100000, // F (—Å–µ–≥–º–µ–Ω—Ç 5)
      0b01000000, // G (—Å–µ–≥–º–µ–Ω—Ç 6)
      0b10000000  // DP (—Å–µ–≥–º–µ–Ω—Ç 7)
  };

  const char *segmentNames[8] = {"A", "B", "C", "D", "E", "F", "G", "DP"};

  for (int seg = 0; seg < 8; seg++)
  {
    Serial.print("–¢–µ—Å—Ç —Å–µ–≥–º–µ–Ω—Ç–∞ ");
    Serial.print(segmentNames[seg]);
    Serial.print(" (–±–∏—Ç ");
    Serial.print(seg);
    Serial.println(")");

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–æ—Ç —Å–µ–≥–º–µ–Ω—Ç –Ω–∞ –≤—Å–µ—Ö 6 —Ü–∏—Ñ—Ä–∞—Ö
    uint8_t testDigits[6];
    for (int i = 0; i < 6; i++)
    {
      testDigits[i] = segments[seg];
    }
    updateDisplay(testDigits);
    delay(1000);
  }

  Serial.println("=== –¢–ï–°–¢ –°–ï–ì–ú–ï–ù–¢–û–í –ó–ê–í–ï–†–®–ï–ù ===");
  clearDisplay();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–æ–∏—Ö –¥–∏—Å–ø–ª–µ–µ–≤ (6 —Ü–∏—Ñ—Ä)
// digits[0] - —Å–∞–º–∞—è –ª–µ–≤–∞—è —Ü–∏—Ñ—Ä–∞, digits[5] - —Å–∞–º–∞—è –ø—Ä–∞–≤–∞—è
// –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–∏—Å–ø–ª–µ–∏ –±—ã–ª–∏ –ø–µ—Ä–µ–ø—É—Ç–∞–Ω—ã –º–µ—Å—Ç–∞–º–∏!
// digits[0-2] –∏–¥—É—Ç –Ω–∞ –ü–†–ê–í–´–ô –¥–∏—Å–ø–ª–µ–π, digits[3-5] –Ω–∞ –õ–ï–í–´–ô
void updateDisplay(uint8_t digits[6])
{
  uint8_t leftDigits[3] = {digits[0], digits[1], digits[2]};
  uint8_t rightDigits[3] = {digits[3], digits[4], digits[5]};

  // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–æ–º–µ–Ω—è–ª –º–µ—Å—Ç–∞–º–∏ –ª–µ–≤—ã–π –∏ –ø—Ä–∞–≤—ã–π –¥–∏—Å–ø–ª–µ–∏
  // –¢–µ–ø–µ—Ä—å digits[0-2] –∏–¥—É—Ç –Ω–∞ –ø—Ä–∞–≤—ã–π –¥–∏—Å–ø–ª–µ–π, digits[3-5] –Ω–∞ –ª–µ–≤—ã–π
  updateSingleDisplay(leftDigits, DISPLAY_RIGHT_DIO, DISPLAY_RIGHT_SCK, DISPLAY_RIGHT_RCK);
  updateSingleDisplay(rightDigits, DISPLAY_LEFT_DIO, DISPLAY_LEFT_SCK, DISPLAY_LEFT_RCK);
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∏—Å–ª–∞ –Ω–∞ –¥–∏—Å–ø–ª–µ–µ (–¥–æ 6 —Ü–∏—Ñ—Ä)
// invertPatterns = true –¥–ª—è –æ–±—â–µ–≥–æ –∞–Ω–æ–¥–∞ (–∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –±–∏—Ç—ã)
void displayNumber(float number, bool invertPatterns = false)
{
  uint8_t digits[6] = {0, 0, 0, 0, 0, 0};

  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω (0-999999)
  if (number < 0)
    number = 0;
  if (number > 999999)
    number = 999999;

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
  // –ò–ª–∏ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å —Ç–æ—á–∫–æ–π, –Ω–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ
  int intValue = (int)number;

  // –ï—Å–ª–∏ —á–∏—Å–ª–æ 0, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É
  if (intValue == 0)
  {
    digits[5] = invertPatterns ? ~digitPatterns[0] : digitPatterns[0];
    updateDisplay(digits);
    return;
  }

  // –†–∞–∑–±–∏–≤–∞–µ–º —á–∏—Å–ª–æ –Ω–∞ —Ü–∏—Ñ—Ä—ã (—Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ)
  int pos = 5; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—Ä–∞–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
  while (intValue > 0 && pos >= 0)
  {
    int digit = intValue % 10;
    digits[pos] = invertPatterns ? ~digitPatterns[digit] : digitPatterns[digit];
    intValue /= 10;
    pos--;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏—Å–ø–ª–µ–π
  updateDisplay(digits);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ—â–Ω–æ—Å—Ç–∏ –∏–∑ Home Assistant —á–µ—Ä–µ–∑ REST API
bool fetchPowerFromHomeAssistant()
{
  if (WiFi.status() != WL_CONNECTED)
  {
    Serial.println("‚ùå WiFi –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –Ω–µ –º–æ–≥—É –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ HA");
    return false;
  }

  HTTPClient http;
  String url = "http://";
  url += ha_server;
  url += ":";
  url += ha_port;
  url += "/api/states/";
  url += ha_entity_id;

  Serial.print("üåê –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Home Assistant: ");
  Serial.println(url);

  http.begin(url);
  http.addHeader("Authorization", String("Bearer ") + ha_token);
  http.addHeader("Content-Type", "application/json");

  int httpCode = http.GET();

  if (httpCode == HTTP_CODE_OK)
  {
    String payload = http.getString();
    Serial.print("‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç HA (");
    Serial.print(payload.length());
    Serial.println(" –±–∞–π—Ç)");

    // –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if (payload.length() > 300)
    {
      Serial.print("üìÑ JSON (–ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤): ");
      Serial.println(payload.substring(0, 300));
    }
    else
    {
      Serial.print("üìÑ JSON: ");
      Serial.println(payload);
    }

    // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç –æ—Ç Home Assistant
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±—É—Ñ–µ—Ä - HA –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    StaticJsonDocument<2048> doc;
    DeserializationError error = deserializeJson(doc, payload);

    if (error)
    {
      Serial.print("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç HA: ");
      Serial.println(error.c_str());
      http.end();
      return false;
    }

    // Home Assistant –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
    // {
    //   "state": "123.45",  // —Å—Ç—Ä–æ–∫–∞ —Å —á–∏—Å–ª–æ–º
    //   "attributes": { ... }
    // }
    if (doc.containsKey("state"))
    {
      const char *stateStr = doc["state"].as<const char *>();
      if (stateStr != nullptr && strlen(stateStr) > 0)
      {
        // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ —á–∏—Å–ª–æ
        float newPower = atof(stateStr);
        if (newPower >= 0) // –í–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        {
          powerWatts = newPower;
          powerReceived = true;
          Serial.print("‚úÖ –ú–æ—â–Ω–æ—Å—Ç—å –∏–∑ HA: ");
          Serial.print(powerWatts);
          Serial.println(" –í—Ç");

          // –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –∞—Ç—Ä–∏–±—É—Ç—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
          if (doc.containsKey("attributes"))
          {
            JsonObject attrs = doc["attributes"];
            if (attrs.containsKey("unit_of_measurement"))
            {
              Serial.print("   –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è: ");
              Serial.println(attrs["unit_of_measurement"].as<const char *>());
            }
          }

          http.end();
          return true;
        }
        else
        {
          Serial.print("‚ö†Ô∏è  –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ HA: '");
          Serial.print(stateStr);
          Serial.println("' (–Ω–µ —á–∏—Å–ª–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)");
        }
      }
    }
    else
    {
      Serial.println("‚ùå –ü–æ–ª–µ 'state' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ HA");
    }
  }
  else if (httpCode == HTTP_CODE_UNAUTHORIZED)
  {
    Serial.println("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ HA (–ø—Ä–æ–≤–µ—Ä—å —Ç–æ–∫–µ–Ω!)");
  }
  else if (httpCode == HTTP_CODE_NOT_FOUND)
  {
    Serial.print("‚ùå Entity –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ HA: ");
    Serial.println(ha_entity_id);
    Serial.println("   –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å entity_id –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö");
  }
  else
  {
    Serial.print("‚ùå HTTP –æ—à–∏–±–∫–∞: ");
    Serial.println(httpCode);
    Serial.print("   –û—Ç–≤–µ—Ç: ");
    Serial.println(http.getString());
  }

  http.end();
  return false;
}

void setup()
{
  Serial.begin(115200);
  delay(1000);

  Serial.println("=== –ü–†–û–°–¢–û–ô –¢–ï–°–¢: –¶–∏—Ñ—Ä—ã 1-6 –Ω–∞ –≤—Å–µ—Ö –¥–∏—Å–ø–ª–µ—è—Ö ===");

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏—Å–ø–ª–µ–π
  initDisplay();
  delay(100);

  Serial.println("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞—é –≤—ã–≤–æ–¥ —Ü–∏—Ñ—Ä 1-6");
}

void loop()
{
  static unsigned long lastChange = 0;
  static int testPos = 0;

  if (millis() - lastChange > 3000) // –ú–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
  {
    lastChange = millis();
    testPos = (testPos + 1) % 6;

    Serial.print("–ü–æ–∑–∏—Ü–∏—è –º–∞—Å—Å–∏–≤–∞ [");
    Serial.print(testPos);
    Serial.println("] - —Ü–∏—Ñ—Ä–∞ 8 (–∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω)");
    Serial.print("  –î–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –Ω–∞ –¥–∏—Å–ø–ª–µ–µ: ");
    if (testPos < 3)
    {
      Serial.print("–ü–†–ê–í–´–ô –¥–∏—Å–ø–ª–µ–π, –ø–æ–∑–∏—Ü–∏—è ");
      Serial.println(testPos + 1);
    }
    else
    {
      Serial.print("–õ–ï–í–´–ô –¥–∏—Å–ø–ª–µ–π, –ø–æ–∑–∏—Ü–∏—è ");
      Serial.println(testPos - 2);
    }
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–∏—Ñ—Ä—É 8 –Ω–∞ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—É—Å—Ç—ã–µ
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –≤–∞—Ä–∏–∞–Ω—Ç 1 —Ä–∞–±–æ—Ç–∞–ª
  uint8_t digits[6] = {0, 0, 0, 0, 0, 0};
  digits[testPos] = ~digitPatterns[8]; // –¶–∏—Ñ—Ä–∞ 8 - –≤—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã

  updateDisplay(digits);
  delay(100);
}
