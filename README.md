# ESP32 + OLED - Монитор розетки Aqara из Home Assistant

Проект для ESP32 DevKit с OLED дисплеями SSD1306, который получает данные о мощности, напряжении, токе и энергии из Home Assistant через REST API и отображает их на встроенных OLED экранах.

## Что это?

Это устройство, которое показывает на OLED дисплеях данные с умной розетки Aqara, подключенной к Home Assistant. Никакого MQTT, никаких танцев с бубном - просто REST API и всё работает как часы.

## Особенности

- ✅ OLED SSD1306 128×64 через I2C - можно подключить от 1 до 4 штук
- ✅ Отображение 4 показателей: мощность (Вт), напряжение (В), ток (А), энергия (кВт·ч)
- ✅ Красивая анимация при старте
- ✅ Стрелки показывают изменение значений (вверх/вниз)
- ✅ Получение данных из Home Assistant через REST API
- ✅ Автоматическое переподключение к WiFi
- ✅ Обновление данных каждые 10 секунд
- ✅ LED индикатор статуса WiFi (опционально)
- ✅ Поддержка конфигурации: 1, 2 или 4 экрана

## Что нужно

- ESP32 DevKit (любая версия)
- OLED дисплей(и) SSD1306 128×64 через I2C
- Home Assistant с настроенной розеткой Aqara
- PlatformIO для сборки и загрузки
- Немного терпения и прямых рук

## Настройка

### 1. Настройка в `src/main.cpp`

Открой файл и настрой следующие параметры:

**WiFi:**
```cpp
#define WIFI_SSID "твоя_сеть"
#define WIFI_PASSWORD "твой_пароль"
```

**Home Assistant:**
```cpp
#define HA_SERVER "192.168.1.100"  // IP адрес Home Assistant
#define HA_PORT 8123               // Порт (или 80 если через reverse proxy)
#define HA_TOKEN "твой_токен"      // Long-Lived Access Token
#define HA_ENTITY_NAME "conditioner_socket"  // Имя сущности (без префикса sensor.)
```

**Количество экранов:**
```cpp
#define DISPLAY_COUNT 1  // 1, 2 или 4
```

**Интервал обновления:**
```cpp
#define UPDATE_INTERVAL_MS 10000  // 10 секунд (в миллисекундах)
```

### 2. Как получить Long-Lived Access Token

1. Зайди в Home Assistant
2. Профиль (внизу слева) → Прокрути вниз → "Токены долгоживущих токенов"
3. Нажми "Создать токен"
4. Скопируй токен и вставь в `HA_TOKEN`

### 3. Как найти Entity ID

1. В Home Assistant: Настройки → Устройства и службы → Zigbee2MQTT (или другой интегратор)
2. Найди свою розетку Aqara
3. Открой сенсоры мощности, напряжения, тока и энергии
4. Entity ID будет указан вверху (например, `sensor.conditioner_socket_power`)
5. В коде укажи только имя без префикса `sensor.` - код сам добавит префиксы для каждого сенсора

### 4. Настройка пинов I2C

По умолчанию используются следующие пины:

```cpp
// Первый дисплей
#define OLED1_SDA 22
#define OLED1_SCL 23

// Второй дисплей
#define OLED2_SDA 25
#define OLED2_SCL 26

// Третий дисплей (для 4 экранов)
#define OLED3_SDA 27
#define OLED3_SCL 14

// Четвертый дисплей (для 4 экранов)
#define OLED4_SDA 12
#define OLED4_SCL 13
```

Если используешь другие пины - измени их в коде.

### 5. Настройка порта в `platformio.ini`

Если твой ESP32 подключен к другому COM порту, измени:
```ini
upload_port = COM4
monitor_port = COM4
```

## Подключение дисплеев

### Для 1 экрана:
- Подключи OLED к пинам SDA=22, SCL=23
- Адрес I2C: 0x3C (по умолчанию)

### Для 2 экранов:
- Первый OLED: SDA=22, SCL=23 (Wire)
- Второй OLED: SDA=25, SCL=26 (Wire1)
- Оба на адресе 0x3C

### Для 4 экранов:
- **ВНИМАНИЕ:** Для 4 экранов с одинаковым адресом 0x3C нужен I2C мультиплексор (например, TCA9548A)
- Или используй дисплеи с разными адресами (0x3C и 0x3D)
- Подключение:
  - Первый: SDA=22, SCL=23
  - Второй: SDA=25, SCL=26
  - Третий: SDA=27, SCL=14
  - Четвертый: SDA=12, SCL=13

## Компиляция и загрузка

### Через PowerShell скрипты (рекомендуется):

**Сборка:**
```powershell
.\build.ps1
```

**Загрузка:**
```powershell
.\upload.ps1
```

**Мониторинг:**
```powershell
.\monitor.ps1
```

**Загрузка с автоматическим сбросом:**
```powershell
.\upload_with_reset.ps1
```

### Через PlatformIO напрямую:

**Сборка:**
```bash
pio run
```

**Загрузка:**
```bash
pio run -t upload
```

**Мониторинг:**
```bash
pio device monitor
```

## Режимы отображения

### 1 экран (DISPLAY_COUNT = 1):
Все 4 показателя на одном экране мелким шрифтом:
- Мощность (Вт)
- Напряжение (В)
- Энергия (кВт·ч)
- Ток (А)

### 2 экрана (DISPLAY_COUNT = 2):
- **Экран 1:** Мощность + Напряжение
- **Экран 2:** Энергия + Ток

### 4 экрана (DISPLAY_COUNT = 4):
- **Экран 1:** Мощность
- **Экран 2:** Напряжение
- **Экран 3:** Энергия
- **Экран 4:** Ток

## Что делает устройство

1. При старте показывает анимацию инициализации на всех экранах
2. Подключается к WiFi
3. Сразу запрашивает текущие значения всех сенсоров из Home Assistant
4. Каждые 10 секунд обновляет данные
5. Отображает значения на OLED дисплеях с индикацией изменений (стрелки вверх/вниз)
6. LED индикатор (GPIO2) показывает статус WiFi (если включен)

## Преимущества REST API над MQTT

- ✅ При перезагрузке ESP32 сразу получает актуальные значения из HA
- ✅ Не нужно настраивать MQTT брокер
- ✅ Проще код, меньше зависимостей
- ✅ Надёжнее - не зависит от MQTT соединения
- ✅ Меньше точек отказа

## Технические детали

- **Плата:** ESP32 DevKit (любая версия)
- **Дисплеи:** OLED SSD1306 128×64 через I2C
- **Библиотеки:** Adafruit SSD1306, Adafruit GFX, ArduinoJson
- **Протокол:** HTTP REST API
- **Обновление:** Каждые 10 секунд (настраивается)
- **LED индикатор:** GPIO2 (опционально, можно отключить)

## Структура проекта

```
src/
├── main.cpp              # Основной файл с настройками
├── AqaraSocketScreen.h   # Класс для работы с OLED
├── AqaraSocketScreen.cpp # Реализация класса
├── display_utils.h       # Утилиты для отображения
├── display_utils.cpp     # Реализация утилит
├── wifi_manager.h        # Менеджер WiFi
├── wifi_manager.cpp      # Реализация WiFi менеджера
├── ha_client.h           # Клиент Home Assistant
└── ha_client.cpp         # Реализация HA клиента
```

## Полезные скрипты

- `build.ps1` - сборка проекта
- `upload.ps1` - загрузка прошивки
- `upload_with_reset.ps1` - загрузка с автоматическим сбросом
- `monitor.ps1` - мониторинг Serial порта
- `check_esp32.ps1` - проверка подключения ESP32
- `check_ports.ps1` - проверка доступных COM портов
- `full_check.ps1` - полная проверка окружения

## Возможные проблемы

### Экран не работает:
- Проверь подключение SDA/SCL
- Проверь адрес I2C (по умолчанию 0x3C)
- Проверь питание дисплея (3.3V и GND)
- Убедись, что в `platformio.ini` указана правильная плата

### WiFi не подключается:
- Проверь SSID и пароль
- Убедись, что WiFi работает на 2.4 ГГц (ESP32 не поддерживает 5 ГГц)
- Проверь, что роутер не блокирует новые устройства

### Не получает данные из HA:
- Проверь IP адрес и порт Home Assistant
- Проверь токен доступа (Long-Lived Access Token)
- Проверь Entity ID сенсоров (должны быть в формате `sensor.имя_power`, `sensor.имя_voltage` и т.д.)
- Проверь, что Home Assistant доступен из сети
- Проверь логи в Serial мониторе

### При загрузке прошивки ошибка:
- Нажми и удерживай кнопку BOOT на ESP32
- Нажми и отпусти кнопку RESET
- Отпусти кнопку BOOT
- Попробуй загрузить снова
- Или используй `upload_with_reset.ps1`

### Для 4 экранов не работает:
- Используй I2C мультиплексор (TCA9548A)
- Или используй дисплеи с разными адресами (0x3C и 0x3D)
- Проверь подключение всех шин I2C

## Лицензия

Делай что хочешь, мне всё равно. Но если сломаешь что-то - это твои проблемы, а не мои.

## Благодарности

- Home Assistant за REST API
- Adafruit за библиотеки
- ESP32 за то, что работает (иногда)
- Тебе за то, что дочитал до конца (или просто пролистал)

## TODO
 * [x] HA REST API
 * [x] WebSocket API
 * [x] MQTT
Можно будет сделать 3 варианта общения с розеткой - все через #define / #ifdef
